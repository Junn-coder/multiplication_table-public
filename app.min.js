const MIN_MULTIPLIER=0,MAX_MULTIPLIER=9,state={mode:"study",selectedNumbers:[1],equationIndex:0,soundOn:!1,equations:[],testQuestions:[],testQuestionsById:{},startByNumber:{},testResultsShown:!1,speakActive:!1,speakPanelVisible:!1,currentEquation:null,masteryMap:{},guideOpen:!1,feedbackOpen:!1,feedbackRating:null,feedbackGoodCount:0,practiceByEquation:{},speakFailures:0,practiceStatus:{},currentPracticeKey:null,feedbackSent:!1,speakWaitingForSpeech:!1},STORAGE_KEY="multiplication_table_start_by_number",MIC_PERMISSION_KEY="multiplication_table_mic_granted_at",MIC_KEEP_MS=3600*1e3,MASTERY_KEY="multiplication_table_mastery",FEEDBACK_COUNT_KEY="multiplication_table_feedback_good",FEEDBACK_API_URL="https://eo9kizm4b2.execute-api.ap-southeast-2.amazonaws.com/feedback",FEEDBACK_NOTE_DEFAULT="Your feedback helps improve the app. Check back later for updates.";function loadStartSettings(){try{const e=window.localStorage.getItem(STORAGE_KEY);if(!e)return;const t=JSON.parse(e);if(t&&typeof t=="object"){const n={};Object.keys(t).forEach(s=>{const a=Number(t[s]);Number.isNaN(a)||(n[s]=a)}),state.startByNumber=n}}catch{state.startByNumber={}}}function saveStartSettings(){try{window.localStorage.setItem(STORAGE_KEY,JSON.stringify(state.startByNumber))}catch{}}function loadMasteryMap(){try{const e=window.localStorage.getItem(MASTERY_KEY);if(!e)return;const t=JSON.parse(e);t&&typeof t=="object"&&(state.masteryMap=t)}catch{state.masteryMap={}}}function saveMasteryMap(){try{window.localStorage.setItem(MASTERY_KEY,JSON.stringify(state.masteryMap))}catch{}}function loadFeedbackCount(){try{const e=window.localStorage.getItem(FEEDBACK_COUNT_KEY);if(!e)return;const t=Number(e);Number.isNaN(t)||(state.feedbackGoodCount=t)}catch{state.feedbackGoodCount=0}}function saveFeedbackCount(){try{window.localStorage.setItem(FEEDBACK_COUNT_KEY,String(state.feedbackGoodCount))}catch{}}function updateFeedbackCountLabel(){const e=document.getElementById("feedback-count");e&&(e.textContent=`Good ratings: ${state.feedbackGoodCount}`)}function masteryKey(e,t){return`${e}x${t}`}function updateMastery(e,t,n){const s=masteryKey(e,t),a=state.masteryMap[s]||{attempts:0,correct:0};a.attempts+=1,n&&(a.correct+=1),state.masteryMap[s]=a}function masteryStatus(e){if(!e||e.attempts===0)return"none";const t=e.correct/e.attempts;return e.attempts>=3&&t<.5?"bad":t>=.8?"good":"warn"}function renderMasteryGrid(){const e=document.getElementById("progress-body");if(e){e.innerHTML="",e.className="mastery-grid";for(let t=0;t<=10;t+=1)for(let n=0;n<=10;n+=1){const s=document.createElement("div");s.className="mastery-cell";const a=masteryKey(t,n),c=state.masteryMap[a],i=masteryStatus(c);t===0&&n===0?s.classList.add("mastery-good"):i!=="none"&&s.classList.add(`mastery-${i}`),s.textContent=`${t} \xD7 ${n}`,e.appendChild(s)}}}function loadMicPermission(){try{const e=window.localStorage.getItem(MIC_PERMISSION_KEY);if(!e)return;const t=Number(e);if(Number.isNaN(t))return;const n=t+MIC_KEEP_MS;Date.now()<n?micKeepUntil=n:window.localStorage.removeItem(MIC_PERMISSION_KEY)}catch{}}function saveMicPermission(){try{window.localStorage.setItem(MIC_PERMISSION_KEY,String(Date.now()))}catch{}}const numberList=document.getElementById("number-list"),equationEl=document.getElementById("equation"),imageFrame=document.getElementById("image-frame"),soundBtn=document.getElementById("sound-btn"),soundHint=document.getElementById("sound-hint"),soundIcon=soundBtn.querySelector(".sound-icon"),equationText=document.getElementById("equation-text"),prevBtn=document.getElementById("prev-btn"),nextBtn=document.getElementById("next-btn"),modeStudy=document.getElementById("mode-study"),modeTest=document.getElementById("mode-test"),statusBar=document.getElementById("status-bar"),testPanel=document.getElementById("test-panel"),testQuestionsEl=document.getElementById("test-questions"),studyPracticeEl=document.getElementById("study-practice"),resultBtn=document.getElementById("result-btn"),progressBtn=document.getElementById("progress-btn"),contentFrame=document.querySelector(".content-frame"),statusStart=document.getElementById("status-start"),startRange=document.getElementById("start-range"),startValue=document.getElementById("start-value"),speakBtn=document.getElementById("mode-speak"),speakPanel=document.getElementById("speak-panel"),speakInstruction=document.getElementById("speak-instruction"),speakResult=document.getElementById("speak-result"),voiceBars=document.querySelectorAll(".voice-bar"),progressModal=document.getElementById("progress-modal"),progressOk=document.getElementById("progress-ok"),progressReset=document.getElementById("progress-reset"),guideBtn=document.getElementById("mode-guide"),guideModal=document.getElementById("guide-modal"),guideOk=document.getElementById("guide-ok"),feedbackBtn=document.getElementById("mode-feedback"),feedbackModal=document.getElementById("feedback-modal"),feedbackOk=document.getElementById("feedback-ok"),feedbackCancel=document.getElementById("feedback-cancel"),rateGood=document.getElementById("rate-good"),rateBad=document.getElementById("rate-bad"),feedbackText=document.getElementById("feedback-text"),feedbackNote=document.querySelector(".feedback-note");let voiceCache=null,speakStream=null,speakAudioContext=null,speakAnalyser=null,speakAnimationId=null,speakRecognition=null,micKeepUntil=0,micKeepTimer=null,labelAutoTimer=null,practiceAdvanceTimer=null,speakCountdownTimer=null,speakSessionToken=0;function selectEnglishVoice(){if(!("speechSynthesis"in window))return null;const t=window.speechSynthesis.getVoices().filter(s=>s.lang&&s.lang.toLowerCase().startsWith("en"));return t.find(s=>/(female|woman|girl|zira|susan|samantha|victoria|karen|tessa|emma|olivia)/i.test(s.name))||t[0]||null}function refreshVoiceCache(){voiceCache=selectEnglishVoice()}"speechSynthesis"in window&&(window.speechSynthesis.onvoiceschanged=refreshVoiceCache);function buildNumberButtons(){for(let t=1;t<=9;t+=1){const n=document.createElement("button");n.type="button",n.className="number-btn",n.textContent=String(t),n.dataset.value=String(t),n.addEventListener("click",()=>handleNumberClick(t)),numberList.appendChild(n)}const e=document.createElement("button");e.type="button",e.className="number-btn",e.textContent="10",e.dataset.value="10",e.addEventListener("click",()=>handleNumberClick(10)),numberList.appendChild(e)}function handleNumberClick(e){const t=[...state.selectedNumbers];if(state.mode==="study"?(state.selectedNumbers=[e],state.speakActive&&stopSpeakSession()):(state.selectedNumbers.includes(e)?state.selectedNumbers=state.selectedNumbers.filter(s=>s!==e):state.selectedNumbers=[...state.selectedNumbers,e],state.selectedNumbers.length===0&&(state.selectedNumbers=[e])),state.equationIndex=0,state.mode==="study")state.testQuestions=[],state.testQuestionsById={},state.testResultsShown=!1;else{const n=state.selectedNumbers.filter(a=>!t.includes(a)),s=t.filter(a=>!state.selectedNumbers.includes(a));updateTestQuestionsForSelection(n,s)}updateUI()}function setMode(e){state.mode=e,state.equationIndex=0,state.testQuestions=[],state.testQuestionsById={},state.testResultsShown=!1,e==="study"&&state.selectedNumbers.length>1&&(state.selectedNumbers=[state.selectedNumbers[0]]),e==="test"&&"speechSynthesis"in window&&window.speechSynthesis.cancel(),e==="test"&&(stopSpeakSession(),state.speakPanelVisible=!1),e==="study"&&(stopSpeakSession(),state.speakPanelVisible=!1),state.guideOpen=!1,state.feedbackOpen=!1,updateUI()}function buildEquations(){const e=[...state.selectedNumbers].sort((n,s)=>n-s),t=[];e.forEach(n=>{const s=state.mode==="study"?Math.max(0,state.startByNumber[n]??0):0;for(let a=s;a<=9;a+=1)t.push({a,b:n})}),state.equations=t,state.equationIndex>=t.length&&(state.equationIndex=0)}function updateButtons(){numberList.querySelectorAll(".number-btn").forEach(n=>{const s=Number(n.dataset.value),a=state.selectedNumbers.includes(s);n.classList.toggle("selected",a)});const t=state.speakPanelVisible;modeStudy.classList.toggle("active",state.mode==="study"&&!t&&!state.guideOpen),modeTest.classList.toggle("active",state.mode==="test"),speakBtn&&speakBtn.classList.toggle("active",t),guideBtn&&guideBtn.classList.toggle("active",state.guideOpen)}function createQuestion(e,t,n){return{id:`${n}:${e}x${t}`,a:e,b:t,group:n,blankType:"product",userAnswer:"",isCorrect:null}}function buildQuestionsForNumber(e){const n=[];for(let o=0;o<=9;o+=1)n.push(o);const s=o=>{for(let l=o.length-1;l>0;l-=1){const f=Math.floor(Math.random()*(l+1));[o[l],o[f]]=[o[f],o[l]]}};s(n);const a=[],c=new Set,i=(o,l)=>{if(a.length>=6)return;const f=`${o}x${l}`;c.has(f)||(c.add(f),a.push(createQuestion(o,l,e)))};if(n.forEach(o=>i(o,e)),a.length<6&&n.forEach(o=>{o!==e&&i(e,o)}),a.length<6){const o=[];for(let l=0;l<=9;l+=1)n.includes(l)||o.push(l);s(o),o.forEach(l=>i(e,l))}const r=["product","product","product","product","left","right"];return s(r),a.forEach((o,l)=>{o.blankType=r[l]||"product",o.id=`${o.group}:${o.a}x${o.b}:${o.blankType}`}),a}function rebuildTestQuestions(){state.testResultsShown=!1,state.testQuestions=[],state.testQuestionsById={},state.selectedNumbers.forEach(e=>{buildQuestionsForNumber(e).forEach(n=>{state.testQuestions.push(n),state.testQuestionsById[n.id]=n})})}function updateTestQuestionsForSelection(e,t){state.mode==="test"&&(t.length>0&&(state.testQuestions=state.testQuestions.filter(n=>!t.includes(n.group)),t.forEach(n=>{Object.keys(state.testQuestionsById).forEach(s=>{state.testQuestionsById[s].group===n&&delete state.testQuestionsById[s]})})),e.length>0&&e.forEach(n=>{buildQuestionsForNumber(n).forEach(a=>{state.testQuestions.push(a),state.testQuestionsById[a.id]=a})}))}function renderTestQuestions(){if(!testQuestionsEl)return;testQuestionsEl.innerHTML="";let e=null,t=null;state.testQuestions.forEach((n,s)=>{if(e!==null&&e!==n.group){const m=document.createElement("div");m.className="test-divider",testQuestionsEl.appendChild(m)}const a=document.createElement("div");a.className="test-question";const c=document.createElement("div");c.className="test-equation";const i=document.createElement("input");i.className="test-input",i.type="text",i.inputMode="numeric",i.autocomplete="off",i.pattern="[0-9]*";const r=n.a*n.b;let o=r;n.blankType==="left"?o=n.a:n.blankType==="right"&&(o=n.b),i.dataset.answer=String(o),i.dataset.qid=n.id,i.value=n.userAnswer,i.setAttribute("aria-label",`Answer for question ${s+1}`),i.addEventListener("input",()=>{if(n.userAnswer=i.value,n.isCorrect!==null){n.isCorrect=null;const m=a.querySelector(".result-icon"),u=a.querySelector(".result-answer");m&&m.classList.remove("correct","incorrect"),u&&(u.textContent=""),i.classList.remove("wrong")}}),i.addEventListener("keydown",m=>{if(m.key==="Enter"){m.preventDefault();const u=Array.from(testQuestionsEl.querySelectorAll(".test-input")),y=u.indexOf(i);if(y>=0){const E=u.slice(y+1).find(h=>h.value.trim()==="");E&&E.focus()}}});const l=document.createElement("span"),f=document.createElement("span");n.blankType==="left"?(l.textContent=`\xD7 ${n.b} = ${r}`,c.appendChild(i),c.appendChild(l)):n.blankType==="right"?(l.textContent=`${n.a} \xD7`,f.textContent=`= ${r}`,c.appendChild(l),c.appendChild(i),c.appendChild(f)):(l.textContent=`${n.a} \xD7 ${n.b} =`,c.appendChild(l),c.appendChild(i));const p=document.createElement("span");p.className="result-icon";const d=document.createElement("span");d.className="result-answer",a.appendChild(c),a.appendChild(p),a.appendChild(d),testQuestionsEl.appendChild(a),state.testResultsShown&&n.isCorrect!==null&&(n.isCorrect?(p.classList.add("correct"),i.classList.remove("wrong"),d.textContent=""):(p.classList.add("incorrect"),i.classList.add("wrong"),n.blankType==="left"?d.textContent=String(n.a):n.blankType==="right"?d.textContent=String(n.b):d.textContent=String(r))),e=n.group,!t&&i.value.trim()===""&&(t=i);const g=()=>{state.mode==="test"&&i.focus()};a.addEventListener("mouseenter",g),a.addEventListener("pointerenter",g),a.addEventListener("pointerdown",g),a.addEventListener("touchstart",g,{passive:!0})}),state.mode==="test"&&t&&t.focus()}function evaluateResults(){if(!testQuestionsEl)return;testQuestionsEl.querySelectorAll(".test-input").forEach(t=>{const n=Number(t.dataset.answer),s=t.value.trim(),a=t.closest(".test-question"),c=a?a.querySelector(".result-icon"):null,i=a?a.querySelector(".result-answer"):null,r=s!==""&&Number(s)===n,o=t.dataset.qid?state.testQuestionsById[t.dataset.qid]:null;c&&(c.classList.toggle("correct",r),c.classList.toggle("incorrect",!r)),t.classList.toggle("wrong",!r),i&&(i.textContent=r?"":`${n}`),o&&(o.userAnswer=s,o.isCorrect=r,updateMastery(o.a,o.b,r))}),state.testResultsShown=!0,saveMasteryMap(),progressModal&&!progressModal.hidden&&renderMasteryGrid()}function updateTestPanel(){if(testPanel){if(resultBtn&&(resultBtn.hidden=state.mode!=="test"),state.mode!=="test"){testPanel.hidden=!0;return}if(testPanel.hidden=!1,state.testQuestions.length===0&&rebuildTestQuestions(),renderTestQuestions(),testPanel){const e=testPanel.scrollHeight>testPanel.clientHeight;testPanel.classList.toggle("scrollable",e)}}}function updateStatus(){if(!statusBar)return;if(state.mode==="study"){const t=state.selectedNumbers[0],n=state.startByNumber[t]??0;state.speakPanelVisible?statusBar.textContent=`In Speak mode, current number: ${t}, start from ${n}.`:statusBar.textContent=`In Study mode, current number: ${t}, start from ${n}.`;return}const e=[...state.selectedNumbers].sort((t,n)=>t-n).join(", ");statusBar.textContent=`In Test mode, selected numbers: ${e}`}function updateEquation(){if(state.mode==="test")return;if(state.equations.length===0){equationEl.textContent="Select a number",state.currentEquation=null,equationText&&(equationText.textContent=""),imageFrame.textContent="";return}const e=state.equations[state.equationIndex];state.currentEquation=e,state.speakFailures=0;const t=practiceKey(e.a,e.b);state.currentPracticeKey!==t&&(state.currentPracticeKey=t,delete state.practiceStatus[t]);const n=e.a*e.b,s=`${e.a} \xD7 ${e.b} = ${n}`,a=`${e.a} times ${e.b} equals ${n}`,c=numberToWords(n);equationEl.innerHTML=`${e.a} \xD7 ${e.b} = <span class="product-number">${n}</span>`,equationText&&(equationText.innerHTML=`${e.a} times ${e.b} equals <span class="product-number">${n}</span>`),updateSpeakInstruction(c),state.speakPanelVisible&&(stopSpeakListening(),"speechSynthesis"in window&&window.speechSynthesis.cancel(),startSpeakSession()),n===0?renderZero(e.b,e.a):renderApples(e.b,e.a),updateStudyPractice(),state.soundOn&&!state.guideOpen&&!state.feedbackOpen&&!state.speakPanelVisible&&speak(a)}function updateSpeakInstruction(e){if(speakInstruction){if(!e&&state.currentEquation){const t=state.currentEquation.a*state.currentEquation.b;e=numberToWords(t)}if(e){const t=String(e).trim();speakInstruction.innerHTML=`Say "<span class="product-number">${t}</span>"`}}}function practiceKey(e,t){return`${e}x${t}`}function updateStudyPractice(){if(!studyPracticeEl)return;if(state.mode!=="study"||state.speakPanelVisible||!state.currentEquation){studyPracticeEl.innerHTML="";return}const{a:e,b:t}=state.currentEquation,n=e*t,s=practiceKey(e,t),a=state.practiceByEquation[s],i=(a&&typeof a=="object"?a:{step:Number.isFinite(a)?a:0}).step??0,r=state.practiceStatus[s]||null,o="\xD7";studyPracticeEl.innerHTML="";const l=document.createElement("div");l.className="study-practice-inner";const f=document.createElement("div");f.className="study-practice-row";const p=document.createElement("div");p.className="study-practice-label",i>=2&&r&&r.type==="ok"?(p.classList.add("practice-done"),p.textContent="Well done!"):p.textContent=r&&r.type==="error"?"Try again:":"Please try here:";const d=document.createElement("div");d.className="study-practice-equation";const g=document.createElement("div");g.className="study-practice-status result-icon",r&&r.type==="ok"?g.classList.add("correct"):r&&r.type==="error"&&g.classList.add("incorrect");const m=k=>{const b=document.createElement("span");b.textContent=k,d.appendChild(b)},u=document.createElement("input");u.type="number",u.inputMode="numeric",u.autocomplete="off",u.className="study-input",u.setAttribute("aria-label","Practice answer"),r&&typeof r.value=="string"&&(u.value=r.value),r&&r.type==="ok"&&(u.disabled=!0);let y=n;i===0?(m(`${e} ${o} `),d.appendChild(u),m(` = ${n}`),y=t):i===1?(d.appendChild(u),m(` ${o} ${t} = ${n}`),y=e):(m(`${e} ${o} ${t} = `),d.appendChild(u),y=n);const E=String(y).length,h=(k=!1)=>{if(r&&r.type==="ok")return;const b=u.value.trim();if(!b||!k&&b.length<E)return;const S=Number(b);if(!Number.isNaN(S)){if(S!=y){state.practiceStatus[s]={type:"error",value:u.value},updateStudyPractice();return}state.practiceStatus[s]={type:"ok",value:u.value},updateStudyPractice(),practiceAdvanceTimer&&(clearTimeout(practiceAdvanceTimer),practiceAdvanceTimer=null),i<2&&(practiceAdvanceTimer=setTimeout(()=>{state.practiceByEquation[s]={step:i+1},delete state.practiceStatus[s],updateStudyPractice()},500))}};u.addEventListener("input",()=>{state.practiceStatus[s]={type:"typing",value:u.value},h()}),u.addEventListener("keydown",k=>{k.key==="Enter"&&h(!0)}),u.addEventListener("blur",()=>{h(!0)}),f.appendChild(p),f.appendChild(d),f.appendChild(g),l.appendChild(f),studyPracticeEl.appendChild(l),(!r||r.type!=="ok")&&setTimeout(()=>{u.focus(),u.select()},0)}function createStudyVisualContainer(e,t){const s=document.createElement("div");return s.className="study-visual",s.style.width=`${e+64}px`,s.style.height=`${t+64}px`,s.style.marginTop="-30px",{container:s,pad:32}}function scheduleLabelAutoShow(e){e&&(labelAutoTimer&&(clearTimeout(labelAutoTimer),labelAutoTimer=null),e.classList.add("show-labels"),labelAutoTimer=setTimeout(()=>{e.classList.remove("show-labels"),labelAutoTimer=null},3e3))}function addStudyLabels(e,t,n,s,a,c,i){const r=document.createElement("div");r.className="image-label factor-label",r.textContent=String(t),r.style.left=`${i+a/2}px`,r.style.top=`${i-10}px`,r.style.transform="translate(-50%, -100%)",e.appendChild(r);const o=document.createElement("div");o.className="image-label factor-label",o.textContent=String(n),o.style.left=`${i-10}px`,o.style.top=`${i+c/2}px`,o.style.transform="translate(-100%, -50%)",e.appendChild(o);const l=document.createElement("div");l.className="image-label product-label",l.textContent=String(s),l.style.left=`${i+a+10}px`,l.style.top=`${i+c/2}px`,l.style.transform="translate(0, -50%)",e.appendChild(l)}function renderZero(e,t){imageFrame.innerHTML="";const n=80,{container:s,pad:a}=createStudyVisualContainer(n,n),c=document.createElement("img");c.src="zero_red.png",c.alt="Zero",c.className="zero-image",c.style.position="absolute",c.style.left=`${a}px`,c.style.top=`${a}px`,s.appendChild(c),addStudyLabels(s,e,t,e*t,n,n,a),scheduleLabelAutoShow(s),imageFrame.appendChild(s)}function renderApples(e,t){imageFrame.innerHTML="";const n=30,s=4,a=Math.max(e,1),c=a*n+(a-1)*s,i=t*n+(t-1)*s,{container:r,pad:o}=createStudyVisualContainer(c,i),l=document.createElement("div");l.className="apple-grid",l.style.gridTemplateColumns=`repeat(${a}, ${n}px)`,l.style.gap=`${s}px`,l.style.position="absolute",l.style.left=`${o}px`,l.style.top=`${o}px`,l.style.width=`${c}px`,l.style.height=`${i}px`,l.style.marginTop="0";for(let f=0;f<t;f+=1)for(let p=0;p<e;p+=1){const d=document.createElement("img");d.src="apple_30pct.png",d.alt="Apple",d.width=n,d.height=n,l.appendChild(d)}r.appendChild(l),addStudyLabels(r,e,t,e*t,c,i,o),scheduleLabelAutoShow(r),imageFrame.appendChild(r)}function speak(e){if(!("speechSynthesis"in window))return;voiceCache||refreshVoiceCache();const t=new SpeechSynthesisUtterance(e);voiceCache&&(t.voice=voiceCache),window.speechSynthesis.cancel(),window.speechSynthesis.speak(t)}function resetVoiceBars(){voiceBars.forEach(e=>{e.style.height="8px"})}function updateVoiceBars(e){voiceBars.forEach(s=>{const a=Math.random()*6,c=Math.min(36,8+e*28+a);s.style.height=`${c}px`})}function releaseMicStream(){speakStream&&(speakStream.getTracks().forEach(e=>e.stop()),speakStream=null),speakAudioContext&&(speakAudioContext.close(),speakAudioContext=null),speakAnalyser=null,micKeepTimer&&(clearTimeout(micKeepTimer),micKeepTimer=null),micKeepUntil=0;try{window.localStorage.removeItem(MIC_PERMISSION_KEY)}catch{}}function scheduleMicRelease(){micKeepTimer&&clearTimeout(micKeepTimer);const e=Math.max(micKeepUntil-Date.now(),0);micKeepTimer=setTimeout(()=>{releaseMicStream()},e)}function startAnalyser(e){if(!e)return;speakAudioContext?speakAudioContext.state==="suspended"&&speakAudioContext.resume():speakAudioContext=new(window.AudioContext||window.webkitAudioContext),speakAnalyser=speakAudioContext.createAnalyser(),speakAnalyser.fftSize=256,speakAudioContext.createMediaStreamSource(e).connect(speakAnalyser);const n=new Uint8Array(speakAnalyser.fftSize),s=()=>{speakAnalyser.getByteTimeDomainData(n);let a=0;for(let i=0;i<n.length;i+=1)a+=Math.abs(n[i]-128);const c=Math.min(1,a/(n.length*32));updateVoiceBars(c),state.speakActive&&(speakAnimationId=requestAnimationFrame(s))};s()}function stopSpeakSession(){speakSessionToken+=1,state.speakActive=!1,state.speakPanelVisible=!1,speakRecognition&&(speakRecognition.onresult=null,speakRecognition.onend=null,speakRecognition.onerror=null,speakRecognition.stop(),speakRecognition=null),speakStream&&Date.now()>=micKeepUntil&&releaseMicStream(),speakAudioContext&&speakAudioContext.state==="running"&&speakAudioContext.suspend(),speakAnimationId&&(cancelAnimationFrame(speakAnimationId),speakAnimationId=null),resetVoiceBars()}function normalizeSpeechTokens(e){const t=e.toLowerCase(),n=t.replace(/-/g," ").replace(/[^a-z\s]/g," ").split(/\s+/).filter(Boolean),s=(t.match(/\d+/g)||[]).flatMap(a=>{const c=Number(a);return Number.isNaN(c)?[]:numberToWords(c).split(" ").filter(Boolean)});return[...n,...s]}function containsPhrase(e,t){if(t.length===0)return!1;for(let n=0;n<=e.length-t.length;n+=1){let s=!0;for(let a=0;a<t.length;a+=1)if(e[n+a]!==t[a]){s=!1;break}if(s)return!0}return!1}function numberToWords(e){const t=["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],n=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];if(e<20)return t[e]||"";const s=Math.floor(e/10),a=e%10;return a===0?n[s]:`${n[s]} ${t[a]}`}function evaluateSpeech(e){if(!state.currentEquation)return{ok:!1,message:"Try again."};const t=state.currentEquation.a*state.currentEquation.b,n=numberToWords(t),s=normalizeSpeechTokens(e),a=n.split(" ").filter(Boolean);return s.length===0||a.length===0?{ok:!1,message:"Try again."}:containsPhrase(s,a)?{ok:!0,message:`Great! ${state.currentEquation.a} times ${state.currentEquation.b} equals ${n}.`}:{ok:!1,message:"Try again."}}function stopSpeakListening(){speakSessionToken+=1,state.speakActive=!1,state.speakWaitingForSpeech=!1,speakCountdownTimer&&(clearInterval(speakCountdownTimer),speakCountdownTimer=null),speakRecognition&&(speakRecognition.onresult=null,speakRecognition.onend=null,speakRecognition.onerror=null,speakRecognition.stop(),speakRecognition=null),speakAudioContext&&speakAudioContext.state==="running"&&speakAudioContext.suspend(),speakAnimationId&&(cancelAnimationFrame(speakAnimationId),speakAnimationId=null),resetVoiceBars()}function playSpeechThenListen(e,t){if(!("speechSynthesis"in window)){t();return}voiceCache||refreshVoiceCache();const n=new SpeechSynthesisUtterance(e);voiceCache&&(n.voice=voiceCache),n.onend=()=>{t()},n.onerror=()=>{t()},window.speechSynthesis.cancel(),window.speechSynthesis.speak(n)}function startSpeakSession(){if(state.mode!=="study"||!speakPanel||state.speakWaitingForSpeech||state.speakActive&&speakRecognition)return;const e=speakSessionToken+=1,t=()=>e!==speakSessionToken;if(state.speakPanelVisible=!0,state.speakActive=!1,state.speakWaitingForSpeech=!1,state.speakFailures=0,speakPanel.hidden=!1,updateSpeakInstruction(),resetVoiceBars(),speakResult&&(speakResult.textContent=""),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){speakResult&&(speakResult.textContent="Microphone not available in this browser."),state.speakActive=!1;return}const n=window.SpeechRecognition||window.webkitSpeechRecognition;if(!n){speakResult&&(speakResult.textContent="Speech recognition not supported."),state.speakActive=!1;return}speakRecognition=new n,speakRecognition.lang="en-US",speakRecognition.continuous=!0,speakRecognition.interimResults=!1,speakRecognition.maxAlternatives=1,speakRecognition.onresult=c=>{if(t())return;const i=typeof c.resultIndex=="number"?c.resultIndex:0,r=c.results[i][0].transcript||"",o=evaluateSpeech(r.toLowerCase());if(speakResult&&(speakResult.textContent=o.message),o.ok){if(state.speakFailures=0,stopSpeakListening(),state.soundOn&&state.currentEquation){const l=state.currentEquation.a*state.currentEquation.b;speak(`${state.currentEquation.a} times ${state.currentEquation.b} equals ${l}`)}return}state.speakFailures+=1,state.speakFailures>=3&&(speakResult&&(speakResult.textContent="You tried 3 times. Please try again later."),stopSpeakListening())},speakRecognition.onerror=()=>{t()||speakResult&&(speakResult.textContent="Could not hear you. Try again.")},speakRecognition.onend=()=>{t()||(state.speakActive?s():state.speakPanelVisible||stopSpeakSession())};const s=()=>{try{speakRecognition.start()}catch{}},a=()=>{if(t())return;state.speakWaitingForSpeech=!1,state.speakActive=!0,updateSpeakInstruction();let i=10;if(speakCountdownTimer&&clearInterval(speakCountdownTimer),speakResult&&(speakResult.textContent=`Listening... ${i}s`),speakCountdownTimer=setInterval(()=>{if(t()){clearInterval(speakCountdownTimer),speakCountdownTimer=null;return}if(!state.speakActive){clearInterval(speakCountdownTimer),speakCountdownTimer=null;return}if(i-=1,i<=0){clearInterval(speakCountdownTimer),speakCountdownTimer=null,speakResult&&(speakResult.textContent="Time is up. Please try again."),stopSpeakListening();return}speakResult&&(speakResult.textContent=`Listening... ${i}s`)},1e3),speakStream&&Date.now()<micKeepUntil){if(t())return;startAnalyser(speakStream),s();return}navigator.mediaDevices.getUserMedia({audio:!0}).then(r=>{if(t()){r.getTracks().forEach(o=>o.stop());return}speakStream=r,micKeepUntil=Date.now()+MIC_KEEP_MS,saveMicPermission(),scheduleMicRelease(),startAnalyser(r),s()}).catch(()=>{t()||(speakResult&&(speakResult.textContent="Microphone permission was denied."),stopSpeakSession())})};state.soundOn&&state.currentEquation?(state.speakWaitingForSpeech=!0,playSpeechThenListen(`${state.currentEquation.a} times ${state.currentEquation.b} equals`,()=>{t()||a()})):a()}function toggleSound(){state.soundOn=!state.soundOn,soundIcon.classList.toggle("sound-on",state.soundOn),soundIcon.classList.toggle("sound-off",!state.soundOn),soundBtn.title=state.soundOn?"Sound on":"Sound off",state.soundOn&&updateEquation()}function nextEquation(){if(state.mode==="test"){testPanel&&testPanel.scrollBy({top:120,behavior:"smooth"});return}state.equations.length!==0&&(state.equationIndex=(state.equationIndex+1)%state.equations.length,updateEquation())}function prevEquation(){if(state.mode==="test"){testPanel&&testPanel.scrollBy({top:-120,behavior:"smooth"});return}state.equations.length!==0&&(state.equationIndex=(state.equationIndex-1+state.equations.length)%state.equations.length,updateEquation())}function updateUI(){if(buildEquations(),updateButtons(),updateTestPanel(),updateEquation(),updateStatus(),contentFrame&&(contentFrame.classList.toggle("test-mode",state.mode==="test"),contentFrame.classList.toggle("speak-mode",state.mode==="study"&&state.speakPanelVisible)),statusStart&&(statusStart.hidden=state.mode!=="study"),prevBtn&&(prevBtn.hidden=state.mode==="test"),nextBtn&&(nextBtn.hidden=state.mode==="test"),resultBtn&&(resultBtn.textContent=state.mode==="test"?"Show Result":"Result"),progressBtn&&(progressBtn.hidden=state.mode!=="test"),progressModal&&state.mode!=="test"&&(progressModal.hidden=!0),guideModal&&(guideModal.hidden=!state.guideOpen),feedbackModal&&(feedbackModal.hidden=!state.feedbackOpen,!state.feedbackOpen&&feedbackText&&(feedbackText.value=""),!state.feedbackOpen&&feedbackNote&&(feedbackNote.textContent=FEEDBACK_NOTE_DEFAULT),!state.feedbackOpen&&feedbackOk&&(feedbackOk.textContent="Send",feedbackOk.disabled=!1)),soundBtn&&(soundBtn.disabled=state.guideOpen||!("speechSynthesis"in window),state.guideOpen?soundBtn.title="Sound disabled in Guide":soundBtn.title=state.soundOn?"Sound on":"Sound off"),speakBtn&&(speakBtn.disabled=!1),speakPanel&&(speakPanel.hidden=!state.speakPanelVisible),state.mode==="study"&&startRange&&startValue){const e=state.selectedNumbers[0],t=state.startByNumber[e]??0;startRange.value=String(t),startValue.textContent=String(t)}}function init(){loadStartSettings(),loadMicPermission(),loadMasteryMap(),loadFeedbackCount(),buildNumberButtons(),resetVoiceBars(),refreshVoiceCache(),progressModal&&(progressModal.hidden=!0),"speechSynthesis"in window?(soundIcon.classList.toggle("sound-on",state.soundOn),soundIcon.classList.toggle("sound-off",!state.soundOn),soundBtn.title=state.soundOn?"Sound on":"Sound off"):(soundBtn.disabled=!0,soundBtn.title="Sound not supported",soundHint.textContent="Sound not supported in this browser."),modeStudy.addEventListener("click",()=>setMode("study")),modeTest.addEventListener("click",()=>setMode("test")),soundBtn.addEventListener("click",toggleSound),nextBtn.addEventListener("click",nextEquation),prevBtn.addEventListener("click",prevEquation),speakBtn&&speakBtn.addEventListener("click",()=>{state.mode!=="study"&&setMode("study"),state.speakActive?(stopSpeakSession(),speakResult&&(speakResult.textContent="")):startSpeakSession(),updateUI()}),document.addEventListener("keydown",e=>{const t=e.target;state.mode!=="study"||t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)||((e.key==="ArrowLeft"||e.key==="<")&&prevEquation(),(e.key==="ArrowRight"||e.key===">")&&nextEquation())}),resultBtn&&resultBtn.addEventListener("click",evaluateResults),progressBtn&&progressBtn.addEventListener("click",()=>{progressModal&&(progressModal.hidden=!1),renderMasteryGrid()}),progressOk&&progressOk.addEventListener("click",()=>{progressModal&&(progressModal.hidden=!0)}),progressReset&&progressReset.addEventListener("click",()=>{state.masteryMap={},saveMasteryMap(),renderMasteryGrid()}),guideBtn&&guideBtn.addEventListener("click",()=>{state.guideOpen=!0,stopSpeakSession(),"speechSynthesis"in window&&window.speechSynthesis.cancel(),updateUI()}),guideOk&&guideOk.addEventListener("click",()=>{state.guideOpen=!1,updateUI()}),feedbackBtn&&feedbackBtn.addEventListener("click",()=>{state.feedbackOpen=!0,state.feedbackRating=null,state.feedbackSent=!1,rateGood&&(rateGood.classList.remove("active"),rateGood.disabled=!1),rateBad&&(rateBad.classList.remove("active"),rateBad.disabled=!1),feedbackNote&&(feedbackNote.textContent=FEEDBACK_NOTE_DEFAULT),feedbackText&&(feedbackText.value="",feedbackText.disabled=!1),feedbackOk&&(feedbackOk.textContent="Send",feedbackOk.disabled=!1),updateUI()}),feedbackOk&&feedbackOk.addEventListener("click",()=>{if(state.feedbackSent){state.feedbackOpen=!1,state.feedbackSent=!1,updateUI();return}const e=feedbackText?feedbackText.value.trim():"";if(!state.feedbackRating){feedbackNote&&(feedbackNote.textContent="Please choose a rating before sending.");return}feedbackOk&&(feedbackOk.disabled=!0,feedbackOk.textContent="Sending..."),fetch(FEEDBACK_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating:state.feedbackRating,comment:e})}).then(async t=>{const n=await t.json().catch(()=>({}));if(!t.ok)throw new Error(n.message||"Send failed.");feedbackNote&&(feedbackNote.textContent="Thanks for your feedback!"),state.feedbackRating=null,state.feedbackSent=!0,rateGood&&(rateGood.disabled=!0),rateBad&&(rateBad.disabled=!0),feedbackText&&(feedbackText.disabled=!0),feedbackOk&&(feedbackOk.textContent="Close")}).catch(t=>{feedbackNote&&(feedbackNote.textContent=t.message||"Send failed. Try again.")}).finally(()=>{feedbackOk&&(feedbackOk.disabled=!1,state.feedbackSent||(feedbackOk.textContent="Send"))})}),feedbackCancel&&feedbackCancel.addEventListener("click",()=>{state.feedbackOpen=!1,state.feedbackSent=!1,rateGood&&(rateGood.disabled=!1),rateBad&&(rateBad.disabled=!1),feedbackText&&(feedbackText.disabled=!1),updateUI()}),rateGood&&rateGood.addEventListener("click",()=>{state.feedbackRating="good",rateGood.classList.add("active"),rateBad&&rateBad.classList.remove("active")}),rateBad&&rateBad.addEventListener("click",()=>{state.feedbackRating="bad",rateBad.classList.add("active"),rateGood&&rateGood.classList.remove("active")}),startRange&&(startRange.addEventListener("input",e=>{if(startValue&&(startValue.textContent=e.target.value),state.mode==="study"){const t=state.selectedNumbers[0];state.startByNumber[t]=Number(e.target.value),saveStartSettings()}}),startRange.addEventListener("change",e=>{if(state.mode!=="study")return;const t=state.selectedNumbers[0];state.startByNumber[t]=Number(e.target.value),startValue&&(startValue.textContent=e.target.value),saveStartSettings(),updateUI()})),updateUI()}init();
